<!DOCTYPE html>
<html>
<head>
	<title>Subtitler</title>
	<link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
	<h1>The Super-Subtitler</h1>
	<h2>Connected to: <div id='socketURL'></div></h2>
	<h3>Select a Language:</h3>
	<select id="selectLang">
		<option value="en-US" selected>English</option>
		<option value="he">Hebrew</option>
		<option value="es">Spanish</option>
		<option value="fr">French</option>
		<option value="de">German</option>
		<option value="zh">Chinese</option>
	</select>
	<button id='start_diction'>Go!</button>

	<span class='footer'>Created by Scott Jones, Ilan Frankel, and Mo Morales for SNAP</span>
</body>
<script  type="text/javascript" charset="utf-8">
		if("WebSocket" in window) {
			//MAKE SURE YOU INPUT YOUR IP ADDRESS BEFORE STARTING THE SERVER
			var ws = new WebSocket('ws://10.221.204.37:8080/p5websocket');
			console.log('socket opened', ws);
			console.log('recognition insantiated');
			var recognition = new webkitSpeechRecognition();

		} else {
			//not supported
			alert('WebSocket not supported');
		}

		ws.onopen = function() {
			console.log("we're connected", ws);
			document.getElementById('socketURL').innerHTML = ws.url;

			//only fire speech event when we are connected to the websocket server
			//start speech recognition
			//currently only Chrome supports this

			recognition.continuous = true;
			recognition.interimResults = true;
			recognition.lang = document.getElementById('selectLang').value;

			recognition.start();
		}

		ws.onclose = function() {
			console.log("we're disconnected", ws);
		}

		recognition.onstart = function() {
			// permission = true;
			console.log('diction started');
		}

		recognition.onend = function() {
			// permission = false;
			console.log('diction ended');
			recognition.stop();
		}

		recognition.onresult = function(event) {
			console.log(event);
			var transcript = event.results[event.results.length-1][0].transcript;

			//add ajax call to translate API here:
			//source is the source language (get this from recognition.lang)
			//target is the target language to be translated TO (en is english)
			//q is query (var transcript)
			//GET https://www.googleapis.com/language/translate/v2?key=AIzaSyC67QxLvpQXXyCI9TWYd5giKl0QeMXHXnU&source=en&target=en&q=Hello%20world
			
			var request = new XMLHttpRequest();
			var query = 'https://www.googleapis.com/language/translate/v2?key=AIzaSyC67QxLvpQXXyCI9TWYd5giKl0QeMXHXnU&source=en&target=en&q=';
			//append source language
			var sourceLanguage = recognition.lang;
			query = query.replace('source=en', 'source=' + sourceLanguage);
			//append transcript
			query += transcript;
			console.log(query);

			request.onreadystatechange = function() {
				if (request.readyState === 4 && request.status === 200) {
					console.log(request.responseText);
					returnedData = JSON.parse(request.responseText);
					//send to websocket
					ws.send(returnedData.data.translations[0].translatedText);
				}
			}

			//open and send request
			request.open('GET', query, true);
			request.send();
		}

		start = document.getElementById('start_diction');

		start.onclick = function() {
			recognition.lang = document.getElementById('selectLang').value;
			recognition.start();
		}

</script>
</html>